
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <title>Complex Crowdsale Â· GitBook</title>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.0">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../part4/inspect-raw-tx.html" />
    
    
    <link rel="prev" href="vevue-ico/" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Part 1 - Running QTUM</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../part1/qtum-docker.html">
            
                <a href="../part1/qtum-docker.html">
            
                    
                    QTUM Docker Container
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="../part1/qtum-docker.html">
            
                <a href="../part1/qtum-docker.html#running-regtest-mode">
            
                    
                    Tip: regtest Mode
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2" data-path="../part1/qtum-docker.html">
            
                <a href="../part1/qtum-docker.html#new-blocks-on-demand">
            
                    
                    Tip: New Blocks On Demand
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.3" data-path="../part1/qtum-docker-codenvy/">
            
                <a href="../part1/qtum-docker-codenvy/">
            
                    
                    Docker In Browser
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../part1/utxos-balances.html">
            
                <a href="../part1/utxos-balances.html">
            
                    
                    UTXOs Accounting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../part1/networks.html">
            
                <a href="../part1/networks.html">
            
                    
                    Test & Main Networks
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.3.1" data-path="../part1/networks.html">
            
                <a href="../part1/networks.html#getting-testnet-tokens">
            
                    
                    Tip: Free Testnet Tokens
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Part 2 - ERC20</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../part2/erc20-token.html">
            
                <a href="../part2/erc20-token.html">
            
                    
                    ERC20 Token
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="../part2/erc20-token.html">
            
                <a href="../part2/erc20-token.html#deploy-contract">
            
                    
                    Deploy Contract
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="../part2/erc20-token.html">
            
                <a href="../part2/erc20-token.html#the-owner-UTXO-address">
            
                    
                    Contract Ownership
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="../part2/erc20-token.html">
            
                <a href="../part2/erc20-token.html#prefunding-the-owner-address">
            
                    
                    Prefund Owner
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="../part2/erc20-token.html">
            
                <a href="../part2/erc20-token.html#using-abiplayer">
            
                    
                    ABIPlayer
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../part2/erc20-js.html">
            
                <a href="../part2/erc20-js.html">
            
                    
                    ERC20 With QtumJS
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.2.1" data-path="../part2/erc20-js.html">
            
                <a href="../part2/erc20-js.html#getting-the-total-supply">
            
                    
                    Load Contract
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.2" data-path="../part2/erc20-js.html">
            
                <a href="../part2/erc20-js.html#calling-a-read-only-method">
            
                    
                    Call Method
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.3" data-path="../part2/erc20-js.html">
            
                <a href="../part2/erc20-js.html#mint-tokens-with-send">
            
                    
                    Send Tx
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.4" data-path="../part2/erc20-js.html">
            
                <a href="../part2/erc20-js.html#observing-contract-events">
            
                    
                    Stream Events
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../part2/erc20-dapp.html">
            
                <a href="../part2/erc20-dapp.html">
            
                    
                    ERC20 DApp
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Part 3 - Crowdsale</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="vevue-ico/">
            
                <a href="vevue-ico/">
            
                    
                    Simple Crowdsale
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="4.2" data-path="ico.html">
            
                <a href="ico.html">
            
                    
                    Complex Crowdsale
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Part 4 - Blockchain API</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../part4/inspect-raw-tx.html">
            
                <a href="../part4/inspect-raw-tx.html">
            
                    
                    Inspect Raw TX
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="../part4/smart-contract.html">
            
                <a href="../part4/smart-contract.html">
            
                    
                    Smart Contract
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Complex Crowdsale</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="holding-a-crowdsale"><a name="holding-a-crowdsale" class="plugin-anchor" href="#holding-a-crowdsale"><i class="fa fa-link" aria-hidden="true"></i></a>Holding A Crowdsale</h1><p>In this chapter, we&apos;ll hold a crowdsale for an ERC20 token. We will use the crowdsale contracts developed by <a href="https://github.com/TokenMarketNet/ico" target="_blank">TokenMarketNet</a>. These contracts are significantly more complex than the toy examples we have seen up to now.</p><p>There are six different roles involved in this setup.</p><p>The human roles:</p><ul><li>The owner of the crowdsale.
</li>
<li>Presale investors.
</li>
<li>ICO Investors.
</li></ul>
<p>The smart contract roles:</p><ul><li>The token minter.
</li>
<li>The token&apos;s release agent.
</li>
<li>The crowdsale finalizing agent.
</li></ul>
<p>The full example can be found in the repo <a href="https://github.com/qtumproject/qtumjs-crowdsale-cli" target="_blank">qtumproject/qtumjs-crowdsale-cli</a>.</p><h2 id="tldr"><a name="tldr" class="plugin-anchor" href="#tldr"><i class="fa fa-link" aria-hidden="true"></i></a>TL;DR</h2><p>An outline of the crowdsale process:</p><ol><li><a href="#the-ico-design">Design the crowdsale and token allocation</a>.
</li>
<li><a href="#deploy-library">Deploy the SafeMathLib library</a>.
</li>
<li><a href="#deploy-the-crowdsale-contracts">Deploy the contracts</a>.
</li>
<li><a href="#crowdsale-setup">Configure the contracts</a>.
</li>
<li><a href="#presale-pre-allocation">Preallocate tokens for pre-sale</a>.
</li>
<li><a href="#public-investment">Allow the public to invest</a>.
</li>
<li><a href="#ending-the-crowdsale">Ending the crowdsale</a>.
<ul><li><a href="#success-finalize-the-crowdsale">If successful, finalize</a>.
</li>
<li><a href="#failure-refund-the-crowdsale">If failed, refund</a>.
</li></ul>
</li></ol>
<p>For a quick overview of the all the commands run for the whole crowdsale process, look at <a href="https://github.com/qtumproject/qtumjs-crowdsale-cli/blob/master/recipe.sh" target="_blank">recipe.sh</a>.</p><p>The NodeJS script that interacts with the crowdsale is <a href="https://github.com/qtumproject/qtumjs-crowdsale-cli/blob/master/index.js" target="_blank">index.js</a>.</p><p>An sample of the deployment data of the contracts involved: <a href="https://github.com/qtumproject/qtumjs-crowdsale-cli/blob/master/solar.development.json.example" target="_blank">solar.development.json</a>.</p><h1 id="the-ico-design"><a name="the-ico-design" class="plugin-anchor" href="#the-ico-design"><i class="fa fa-link" aria-hidden="true"></i></a>The ICO Design</h1><p>The TokenMarketNet contracts cover many common scenarios for ICOs, providing support for different types of tokens, different caps, and different pricing strategies.</p><p>Our crowdsale will have the following configuration:</p><ul><li>BurnableCrowdsaleToken
</li></ul>
<p>This is essentially a mintable token. It also provides the option to burn tokens, for example if you&apos;d like to lower the percentage of tokens the team holds if the crowdsale did not reach the maximum sales goal.</p><ul><li>FlatPricing
</li></ul>
<p>Everyone that participates in the public sale gets the same price. There are other pricing strategies like <a href="https://github.com/TokenMarketNet/ico/blob/master/contracts/TokenTranchePricing.sol" target="_blank">TokenTranchePricing</a> or <a href="https://github.com/TokenMarketNet/ico/blob/master/contracts/MilestonePricing.sol" target="_blank">MilestonePricing</a>.</p><p>The prices are specified in satoshi (10^-8) per token.</p><ul><li>MintedTokenCappedCrowdsale
</li></ul>
<p>This is a crowdsale capped by number of tokens sold.</p><h2 id="supply-allocation-and-pricing"><a name="supply-allocation-and-pricing" class="plugin-anchor" href="#supply-allocation-and-pricing"><i class="fa fa-link" aria-hidden="true"></i></a>Supply, Allocation, And Pricing</h2><p>Let&apos;s now determine the parameters for this crowdsale. For simplicity, we&apos;ll assume that qtum&apos;s price is $100 USD.</p><p>The name:</p><ul><li>Token name: MyToken
</li>
<li>Token symbol: MTK
</li>
<li>Decimals: 0 (for indivisible tokens. See: <a href="https://medium.com/@jgm.orinoco/understanding-erc-20-token-contracts-a809a7310aa5" target="_blank">Understanding ERC20</a>).
</li></ul>
<p>The supply allocation is as follows:</p><ul><li>Total Supply: 100,000,000 MTK
</li>
<li>Team: 10%
</li>
<li>Foundation: 20%
</li>
<li>Presale: 10%, at 50% discount
</li>
<li>Public ICO: 60%
</li></ul>
<p>The prices are:</p><ul><li><p>Presale</p><ul><li>Price: 50000 QTUM Satoshi ($0.05 in fiat)
</li>
<li>Presale tokens: 10,000,000
</li>
<li>2000 MTK : 1 QTUM
</li>
<li>Presale amount: 5000 QTUM ($500,000)
</li></ul>
</li>
<li><p>Public ICO</p><ul><li>Price: 100000 QTUM Satoshi ($0.1 in fiat)
</li>
<li>ICO tokens: 60,000,000
</li>
<li>1000 MTK : 1 QTUM
</li>
<li>ICO funding: 60000 QTUM ($6,000,000)
</li></ul>
</li></ul>
<p>The valuation of the token is 10M post ICO.</p><h1 id="running-the-code"><a name="running-the-code" class="plugin-anchor" href="#running-the-code"><i class="fa fa-link" aria-hidden="true"></i></a>Running The Code</h1><p>Clone contracts:</p><pre><code>git clone --recursive \
  https://github.com/qtumproject/qtumjs-crowdsale-cli</code></pre>
<h2 id="running-qtumd"><a name="running-qtumd" class="plugin-anchor" href="#running-qtumd"><i class="fa fa-link" aria-hidden="true"></i></a>Running QTUMD</h2><p>Run qtumd in regtest mode:</p><pre><code>docker run -it --rm \
  --name myico \
  -v `pwd`:/dapp \
  -p 3889:3889 \
  -p 9899:9899 \
  -p 9888:9888 \
  hayeah/qtumportal</code></pre>
<p>Then generate some initial blocks:</p><pre><code>docker exec -it myico sh</code></pre>
<pre><code>qcli generate 600</code></pre>
<h1 id="configure-the-ico-owner-address"><a name="configure-the-ico-owner-address" class="plugin-anchor" href="#configure-the-ico-owner-address"><i class="fa fa-link" aria-hidden="true"></i></a>Configure The ICO Owner Address</h1><p>We&apos;ll need to create an address that &quot;owns&quot; all the contracts related to this ICO.</p><pre><code>qcli getnewaddress
qf292iYbjJ41oMoArA3PrHpxTdAHuQsuAu

qcli gethexaddress qf292iYbjJ41oMoArA3PrHpxTdAHuQsuAu
eb6a149ec16aaaa6e47b6c0048520f7d9563b20a</code></pre>
<p>Prefund it with 100 UTXOs:</p><pre><code>solar prefund qf292iYbjJ41oMoArA3PrHpxTdAHuQsuAu 0.1 100</code></pre>
<p>Then we need to configure <code>solar</code> to use this address when creating contracts (otherwise a random UTXO would be selected as the owner). In the container shell, set the <code>QTUM_SENDER</code> environment variable:</p><pre><code>export QTUM_SENDER=qf292iYbjJ41oMoArA3PrHpxTdAHuQsuAu</code></pre>
<p>We will also use the owner address to receive the crowdsale investment.</p><h1 id="deploy-library"><a name="deploy-library" class="plugin-anchor" href="#deploy-library"><i class="fa fa-link" aria-hidden="true"></i></a>Deploy Library</h1><p>The crowdsale contracts rely on the <code>SafeMathLib</code> library for arithemetics, so that integer overflows would raise errors.</p><p>Use the <code>lib</code> option to deploy a contract as library:</p><pre><code>solar deploy contracts/SafeMathLib.sol --lib

&#x1F680;  All contracts confirmed
   deployed contracts/SafeMathLib.sol =&gt; 26fe40c433b4d109299660284eaa475b95462342</code></pre>
<p>Once deployed, other contracts that reference the <code>SafeMathLib</code> library are automatically linked to the library instance deployed at the address <code>26fe40c433b4d109299660284eaa475b95462342</code>.</p><h1 id="deploy-the-crowdsale-contracts"><a name="deploy-the-crowdsale-contracts" class="plugin-anchor" href="#deploy-the-crowdsale-contracts"><i class="fa fa-link" aria-hidden="true"></i></a>Deploy The Crowdsale Contracts</h1><p>There are four contracts to deploy.</p><h2 id="the-erc20-token"><a name="the-erc20-token" class="plugin-anchor" href="#the-erc20-token"><i class="fa fa-link" aria-hidden="true"></i></a>The ERC20 Token</h2><p>The constructor for the ERC20 token:</p><pre><code>BurnableCrowdsaleToken(
  string _name,
  string _symbol,
  uint _initialSupply,
  uint _decimals,
  bool _mintable)</code></pre>
<p><a href="https://github.com/TokenMarketNet/ico/blob/master/contracts/BurnableCrowdsaleToken.sol#L18" target="_blank">https://github.com/TokenMarketNet/ico/blob/master/contracts/BurnableCrowdsaleToken.sol#L18</a></p><p>Per the supply allocation plan, we allocate 10% to team and 20% to foundation, for a total of 30,000,000 tokens.</p><pre><code>solar deploy contracts/BurnableCrowdsaleToken.sol:MyToken &apos;
[
  &quot;MyToken&quot;,
  &quot;MTK&quot;,
  30000000,
  0,
  true
]
&apos;

&#x1F680;  All contracts confirmed
   deployed MyToken =&gt; 92105c87931dea43d9901bd944a48d3b8a0268ad</code></pre>
<p>The initial supply is set to 30M, with the tokens assigned to the contract owner. These tokens may later be transferred to the foundation and team vesting vault as necessary.</p><h2 id="pricing-strategy"><a name="pricing-strategy" class="plugin-anchor" href="#pricing-strategy"><i class="fa fa-link" aria-hidden="true"></i></a>Pricing Strategy</h2><p>The constructor for the <code>FlatPricing</code> strategy is straightforward:</p><pre><code>function FlatPricing(uint _oneTokenInWei)</code></pre>
<p><a href="https://github.com/TokenMarketNet/ico/blob/f5b3ac6b5773f707943289b6ab1914a6b4e30683/contracts/FlatPricing.sol#L22" target="_blank">https://github.com/TokenMarketNet/ico/blob/f5b3ac6b5773f707943289b6ab1914a6b4e30683/contracts/FlatPricing.sol#L22</a></p><p>Note that this contract was written for Ethereum, whose smallest unit is <code>wei</code> (10^-9). However, QTUM inherits its ledger from Bitcoin, whose smallest unit is <code>satoshi</code> (10^-8).</p><p>So even though the constructor parameter name is <code>_oneTokenInWei</code>, what it really means is <code>_oneTokenInSatoshi</code>.</p><p>The price for the public ICO is 100000 qtum satoshi (1000 MTK : 1 qtum).</p><pre><code>solar deploy contracts/FlatPricing.sol &apos;
[
  100000
]
&apos;</code></pre>
<h2 id="crowdsale-contract"><a name="crowdsale-contract" class="plugin-anchor" href="#crowdsale-contract"><i class="fa fa-link" aria-hidden="true"></i></a>Crowdsale Contract</h2><p>The crowdsale contract has a more complicated constructor:</p><pre><code>function MintedTokenCappedCrowdsale(
  address _token,
  PricingStrategy _pricingStrategy,
  address _multisigWallet,
  uint _start,
  uint _end,
  uint _minimumFundingGoal,
  uint _maximumSellableTokens)
  Crowdsale(
    _token, _pricingStrategy, _multisigWallet,
    _start, _end, _minimumFundingGoal) {
    maximumSellableTokens = _maximumSellableTokens;
}</code></pre>
<p>We&apos;ll need the start and end time, in <a href="https://en.wikipedia.org/wiki/Unix_time" target="_blank">unix time</a>:</p><pre><code>&gt; new Date(&apos;2018-01-15T00:00:00Z&apos;) / 1000
1515974400
&gt; new Date(&apos;2018-03-01T00:00:00Z&apos;) / 1000
1519862400</code></pre>
<p>The deploy command:</p><pre><code>solar deploy contracts/MintedTokenCappedCrowdsale.sol:Crowdsale &apos;
[
  ${MyToken},
  ${contracts/FlatPricing.sol},
  &quot;0xeb6a149ec16aaaa6e47b6c0048520f7d9563b20a&quot;,
  1515974400,
  1519862400,
  1200000000000,
  60000000
]
&apos;</code></pre>
<p>The constructor parameters are described below:</p><ul><li><p><code>_token</code></p><ul><li>Use <code>${MyToken}</code> to interpolate the address of the <code>MyToken</code> contract.
</li></ul>
</li>
<li><p><code>_pricingStrategy</code></p><ul><li>Use <code>${contracts/FlatPricing.sol}</code> to interpolate the address of pricing strategy.
</li></ul>
</li>
<li><p><code>_multisigWallet</code></p><ul><li><code>0xeb6a149ec16aaaa6e47b6c0048520f7d9563b20a</code>, the owner address.
</li></ul>
</li>
<li><p><code>_minimumFundingGoal</code>, specified in satoshi.</p><ul><li>Let&apos;s set it to 20% of the funding cap.
</li>
<li>60000 qtum <em> 20% == 12000 qtum == 12000 </em> 10^8 satoshi == 1200000000000 satoshi
</li></ul>
</li>
<li><p><code>_maximumSellableTokens</code></p><ul><li>60,000,000 tokens
</li></ul>
</li></ul>
<h2 id="finalize-agent"><a name="finalize-agent" class="plugin-anchor" href="#finalize-agent"><i class="fa fa-link" aria-hidden="true"></i></a>Finalize Agent</h2><p>The finalize agent is a way to specify a callback that should execute when the crowdsale is successful. The least it needs to do is to release the tokens so holders are free to transfer tokens.</p><p>In this example we use the <code>DefaultFinalizeAgent</code>, which releases the token, and does nothing else:</p><pre><code>function DefaultFinalizeAgent(
  ReleasableToken _token,
  Crowdsale _crowdsale
)</code></pre>
<p>To deploy it:</p><pre><code>solar deploy contracts/DefaultFinalizeAgent.sol:FinalizeAgent &apos;
[
  ${MyToken},
  ${Crowdsale}
]
&apos;</code></pre>
<h1 id="sanity-check"><a name="sanity-check" class="plugin-anchor" href="#sanity-check"><i class="fa fa-link" aria-hidden="true"></i></a>Sanity Check</h1><p>You should now have four contracts deployed:</p><pre><code>solar status

&#x2705;  MyToken
        txid: b11f5def8559a5c351a153f8f3b8eead23fb73bfc218fe951ac7de3205205972
     address: 92105c87931dea43d9901bd944a48d3b8a0268ad
   confirmed: true
       owner: qf292iYbjJ41oMoArA3PrHpxTdAHuQsuAu

&#x2705;  contracts/FlatPricing.sol
        txid: 2c327ebcbda2fae979b9d1c0a99973535c22bdec2bb9c96d80dea57b10c9b8ea
     address: 8f52355c4de8dc1d3104b3773aa8c3ca31f890d1
   confirmed: true
       owner: qf292iYbjJ41oMoArA3PrHpxTdAHuQsuAu

&#x2705;  FinalizeAgent
        txid: 4d56e06efe5ef4b124421cbc1bc6ff399e1fbce9175b58221f802bf12742835d
     address: c1ac5d69763da27e9c8fe319427c80a167298a6d
   confirmed: true
       owner: qf292iYbjJ41oMoArA3PrHpxTdAHuQsuAu

&#x2705;  Crowdsale
        txid: c99daf64a18fac29f006d88644e3e7d3c9abc8950d23f5f467b18a7da1766d26
     address: f96403c9431ed464dd0063d18756718ac78f1edb
   confirmed: true
       owner: qf292iYbjJ41oMoArA3PrHpxTdAHuQsuAu</code></pre>
<p>Make sure that all of them share the same owner. If not, make sure that the environment variable <code>QTUM_SENDER</code> is set to the owner address, and try again.</p><p>You may query for the basic information about these contracts using qtumjs:</p><pre><code class="lang-ts"><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;token supply:&quot;</span>, await mytoken.return(<span class="hljs-string">&quot;totalSupply&quot;</span>))
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;crowdsale state:&quot;</span>, await crowdsale.returnAs(stateName, <span class="hljs-string">&quot;getState&quot;</span>))
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;crowdsale start date:&quot;</span>, await crowdsale.returnDate(<span class="hljs-string">&quot;startsAt&quot;</span>))
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;crowdsale end date:&quot;</span>, await crowdsale.returnDate(<span class="hljs-string">&quot;endsAt&quot;</span>))

<span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;investor count:&quot;</span>, await crowdsale.return(<span class="hljs-string">&quot;investorCount&quot;</span>))
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;qtum raised:&quot;</span>, await crowdsale.returnCurrency(<span class="hljs-string">&quot;qtum&quot;</span>, <span class="hljs-string">&quot;weiRaised&quot;</span>))
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;tokens sold:&quot;</span>, await crowdsale.return(<span class="hljs-string">&quot;tokensSold&quot;</span>))</code></pre>
<p>Run the CLI script to print the info:</p><pre><code>node index.js info

token supply: 30000000
crowdsale state: Preparing
crowdsale start date: 2018-01-15T00:00:00.000Z
crowdsale end date: 2018-03-01T00:00:00.000Z
investor count: 0
qtum raised: 0
tokens sold: 0</code></pre>
<p>Note that the state is in <code>Preparing</code>, not quite ready for action.</p><h1 id="crowdsale-setup"><a name="crowdsale-setup" class="plugin-anchor" href="#crowdsale-setup"><i class="fa fa-link" aria-hidden="true"></i></a>Crowdsale Setup</h1><p>There is just a bit more setup, to grant permissions to different contracts to do their jobs.</p><p>The setup script:</p><pre><code class="lang-ts">async <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupCrowdsale</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-comment">// Set the finalize agent as token&apos;s release agent</span>
  <span class="hljs-keyword">if</span> (await mytoken.return(<span class="hljs-string">&quot;releaseAgent&quot;</span>) !== finalizeAgent.address) {
    <span class="hljs-keyword">let</span> tx = await mytoken.send(<span class="hljs-string">&quot;setReleaseAgent&quot;</span>, [finalizeAgent.address])
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;confirming mytoken.setReleaseAgent:&quot;</span>, tx.txid)
    <span class="hljs-keyword">let</span> receipt = await tx.confirm(<span class="hljs-number">1</span>)
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;mytoken.setReleaseAgent receipt&quot;</span>, receipt)
  }
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;releaseAgent coinfigured&quot;</span>)

  <span class="hljs-comment">// Set crowdsale&apos;s finalize agent</span>
  <span class="hljs-keyword">if</span> (await crowdsale.return(<span class="hljs-string">&quot;finalizeAgent&quot;</span>) !== finalizeAgent.address) {
    tx = await crowdsale.send(<span class="hljs-string">&quot;setFinalizeAgent&quot;</span>, [finalizeAgent.address])
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;confirming crowdsale.setFinalizeAgent:&quot;</span>, tx.txid)
    receipt = await tx.confirm(<span class="hljs-number">1</span>)
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;crowdsale.setFinalizeAgent receipt&quot;</span>, receipt)
  }
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;finalizeAgent coinfigured&quot;</span>)

  <span class="hljs-comment">// The mint agent of the token should be the crowdsale contract.</span>
  <span class="hljs-comment">// `true` means this address is allow to mint. `false` to disable a mint agent.</span>
  <span class="hljs-keyword">if</span> (await mytoken.return(<span class="hljs-string">&quot;mintAgents&quot;</span>, [crowdsale.address]) !== <span class="hljs-literal">true</span>) {
    tx = await mytoken.send(<span class="hljs-string">&quot;setMintAgent&quot;</span>, [crowdsale.address, <span class="hljs-literal">true</span>])
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;confirming mytoken.setMintAgent:&quot;</span>, tx.txid)
    receipt = await tx.confirm(<span class="hljs-number">1</span>)
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;mytoken.setMintAgent receipt&quot;</span>, receipt)
  }
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;mintAgents coinfigured&quot;</span>)
}</code></pre>
<p>Run the script with node:</p><pre><code>node index.js setup

releaseAgent coinfigured
finalizeAgent coinfigured
mintAgents coinfigured</code></pre>
<p>Getting the info again, you should see that the crowdsale state have transitioned to <code>PreFunding</code>:</p><pre><code>node index.js info

token supply: 30000000
crowdsale state: PreFunding
crowdsale start date: 2018-01-15T00:00:00.000Z
crowdsale end date: 2018-03-01T00:00:00.000Z
investor count: 0
qtum raised: 0
tokens sold: 0</code></pre>
<blockquote><p>The info shows the state as <code>PreFunding</code> even if the current time had past the start date. The actual state should be <code>Funding</code>. This problem will be fixed by <a href="https://github.com/qtumproject/qtum/issues/480" target="_blank">qtum #480</a></p></blockquote><h1 id="presale-pre-allocation"><a name="presale-pre-allocation" class="plugin-anchor" href="#presale-pre-allocation"><i class="fa fa-link" aria-hidden="true"></i></a>Presale Pre-Allocation</h1><p>According to our ICO plan, we have already sold 10% of the token supply (10,000,000) to early investors. We&apos;d like to record their investments on the ledger.</p><p>We assume that there are two investors, who invested at the same price:</p><pre><code class="lang-yaml"><span class="hljs-attr">- address:</span> <span class="hljs-string">&quot;77913e470293e72c1e93ed8dda8c1372dfc0274f&quot;</span>
<span class="hljs-attr">  tokens:</span> <span class="hljs-number">6000000</span>
<span class="hljs-attr">  price:</span> <span class="hljs-number">50000</span>

<span class="hljs-attr">- address:</span> <span class="hljs-string">&quot;78d55bb60f8c0e80fda479b02e40407ee0a88ab1&quot;</span>
<span class="hljs-attr">  tokens:</span> <span class="hljs-number">4000000</span>
<span class="hljs-attr">  price:</span> <span class="hljs-number">50000</span></code></pre>
<p>The <a href="https://github.com/TokenMarketNet/ico/blob/2835f331fd9a9356131dfcf0ddd2cee471b9e32f/contracts/Crowdsale.sol#L65" target="_blank">preallocate</a> method allows the crowdsale owner to assign tokens to investor addresses. It is assumed that the investment money had already been transfered to the owner privately.</p><pre><code>function preallocate(
  address receiver,
  uint fullTokens,
  uint weiPrice
) public onlyOwner;</code></pre>
<p>To invoke <code>preallocate</code> with qtumjs:</p><pre><code class="lang-ts">async <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">preallocate</span>(<span class="hljs-params">receiverAddress, tokens, price</span>) </span>{
  <span class="hljs-keyword">const</span> tx = await crowdsale.send(<span class="hljs-string">&quot;preallocate&quot;</span>, [receiverAddress, tokens, price])
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;preallocate txid&quot;</span>, tx.txid)

  <span class="hljs-keyword">const</span> receipt = await tx.confirm(<span class="hljs-number">1</span>)
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;preallocate receipt:&quot;</span>)

  <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">JSON</span>.stringify(receipt, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>))
}</code></pre>
<p>Let&apos;s use the CLI script to allocate tokens to the first investor:</p><pre><code>node index.js preallocate \
  77913e470293e72c1e93ed8dda8c1372dfc0274f \
  6000000 \
  50000</code></pre>
<p>After the transaction confirms, you should see that the events <code>Transfer</code> and <code>Invested</code> are generated:</p><pre><code>&quot;logs&quot;: [
  {
    &quot;value&quot;: &quot;5b8d80&quot;,
    &quot;from&quot;: &quot;0000000000000000000000000000000000000000&quot;,
    &quot;to&quot;: &quot;77913e470293e72c1e93ed8dda8c1372dfc0274f&quot;,
    &quot;type&quot;: &quot;Transfer&quot;
  },
  {
    &quot;investor&quot;: &quot;77913e470293e72c1e93ed8dda8c1372dfc0274f&quot;,
    &quot;weiAmount&quot;: &quot;45d964b800&quot;,
    &quot;tokenAmount&quot;: &quot;5b8d80&quot;,
    &quot;customerId&quot;: &quot;0&quot;,
    &quot;type&quot;: &quot;Invested&quot;
  }
]</code></pre>
<p>Check that the ledger had indeed allocated the tokens to this investor:</p><pre><code>node index.js investedBy \
  77913e470293e72c1e93ed8dda8c1372dfc0274f

invested by: 77913e470293e72c1e93ed8dda8c1372dfc0274f
amount (qtum): 3000
token balance: 6000000</code></pre>
<p>We&apos;ve finished allocation for one investor, let&apos;s repeat it for the second investor:</p><pre><code>node index.js preallocate \
  78d55bb60f8c0e80fda479b02e40407ee0a88ab1 \
  4000000 \
  50000</code></pre>
<p>Check the ledger:</p><pre><code>node index.js investedBy 78d55bb60f8c0e80fda479b02e40407ee0a88ab1

invested by: 78d55bb60f8c0e80fda479b02e40407ee0a88ab1
amount (qtum): 2000
token balance: 4000000</code></pre>
<p>After preallocation, the crowdsale info should have changed accordingly:</p><pre><code>node index.js info

token supply: 40000000
crowdsale state: PreFunding
crowdsale start date: 2018-01-15T00:00:00.000Z
crowdsale end date: 2018-03-01T00:00:00.000Z
investor count: 0
qtum raised: 5000
tokens sold: 10000000</code></pre>
<blockquote><p>Note: the investor count is still 0 because the contract implementation assumes that one preallocation address may in fact distribute the tokens further to an arbitrary number of a smaller investors.</p></blockquote><h1 id="public-investment"><a name="public-investment" class="plugin-anchor" href="#public-investment"><i class="fa fa-link" aria-hidden="true"></i></a>Public Investment</h1><p>Once the crowdsale is in the <code>Funding</code> state, public investors may start to send in money. We&apos;ll let the investors use the <a href="https://github.com/TokenMarketNet/ico/blob/2835f331fd9a9356131dfcf0ddd2cee471b9e32f/contracts/Crowdsale.sol#L104" target="_blank">invest</a> method.</p><blockquote><p>The precise conditions that determines the state of the crowdsale is defined in the <a href="https://github.com/TokenMarketNet/ico/blob/2835f331fd9a9356131dfcf0ddd2cee471b9e32f/contracts/CrowdsaleBase.sol#L361" target="_blank">getState</a> method.</p></blockquote><p>The <code>invest</code> method sends in an amount of qtum, and receive a corresponding amount of tokens as determined by the pricing strategy. This method is more expensive to compute, so we set a higher gas limit of 300,000:</p><pre><code class="lang-ts">async <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">invest</span>(<span class="hljs-params">address, amount</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;invest&quot;</span>, address, amount)
  <span class="hljs-keyword">const</span> tx = await crowdsale.send(<span class="hljs-string">&quot;invest&quot;</span>, [address], {
    amount,
    gasLimit: <span class="hljs-number">300000</span>,
  })
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;invest txid&quot;</span>, tx.txid)
  <span class="hljs-keyword">const</span> receipt = await tx.confirm(<span class="hljs-number">1</span>)
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;invest receipt:&quot;</span>)
  <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">JSON</span>.stringify(receipt, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>))
}</code></pre>
<p>Invoke the CLI tool to invest 7000 QTUMs:</p><pre><code>node index.js invest \
  6607919dd81d8e958b31e2ef089139505faada4d \
  7000</code></pre>
<p>After confirmation, we should see that this address had received 3000 MTKs:</p><pre><code>node index.js investedBy 6607919dd81d8e958b31e2ef089139505faada4d

invested by: 6607919dd81d8e958b31e2ef089139505faada4d
amount (qtum): 7000
token balance: 7000000</code></pre>
<p>And the crowdsale info should have updated as well:</p><pre><code>node index.js info

investor count: 1
qtum raised: 12000
tokens sold: 17000000
minimum funding goal: 12000
minimum funding goal reached: true</code></pre>
<p>This single investor had helped us reach the funding goal!</p><h2 id="the-default-payment-method"><a name="the-default-payment-method" class="plugin-anchor" href="#the-default-payment-method"><i class="fa fa-link" aria-hidden="true"></i></a>The Default Payment Method</h2><p>By default an investor is not allowed to invest by sending money to this contract directly. The default action is to throw:</p><pre><code>/**
  * Don&apos;t expect to just send in money and get tokens.
  */
function() payable {
  throw;
}</code></pre>
<p>If this is a desired behaviour, you could override the default method in your on subclass of the <code>Crowdsale</code> contract.</p><h1 id="ending-the-crowdsale"><a name="ending-the-crowdsale" class="plugin-anchor" href="#ending-the-crowdsale"><i class="fa fa-link" aria-hidden="true"></i></a>Ending The Crowdsale</h1><p>There are two ways to end a crowdsale once the end date is reached, depending on whether the sale was successful.</p><ol><li>If the minimum funding goal was reached, finalize the crowdsale, so investors can start to transfer and trade the tokens.
</li>
<li>If the minimum funding goal was not reached, refund each investor the amount they sent.
</li></ol>
<h2 id="ending-early"><a name="ending-early" class="plugin-anchor" href="#ending-early"><i class="fa fa-link" aria-hidden="true"></i></a>Ending Early</h2><p>We can set the <code>endsAt</code> property of the contract to either extend the deadline or to end the crowdsale early.</p><p>For our example, we&apos;ll end the crowdsale early. Invoke the <a href="https://github.com/TokenMarketNet/ico/blob/2835f331fd9a9356131dfcf0ddd2cee471b9e32f/contracts/CrowdsaleBase.sol#L265" target="_blank">setEndsAt</a> method to end the crowdsale 60 seconds from now:</p><pre><code class="lang-ts">async <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">endCrowdsaleNow</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> nowDate = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
  <span class="hljs-comment">// You may need to choose a larger delay than 60s on a</span>
  <span class="hljs-comment">// real network, where there may be a larger clock skew.</span>
  <span class="hljs-keyword">const</span> now = <span class="hljs-built_in">Math</span>.floor(nowDate / <span class="hljs-number">1000</span>) + <span class="hljs-number">60</span>
  <span class="hljs-keyword">const</span> tx = await crowdsale.send(<span class="hljs-string">&quot;setEndsAt&quot;</span>, [now])
  <span class="hljs-keyword">const</span> receipt = await tx.confirm(<span class="hljs-number">1</span>)
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;end now receipt:&quot;</span>)
  <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">JSON</span>.stringify(receipt, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>))
}</code></pre>
<p>Run the CLI script:</p><pre><code class="lang-json">node index.js endnow</code></pre>
<p>The expected output:</p><pre><code class="lang-json">{
  <span class="hljs-string">&quot;blockHash&quot;</span>: <span class="hljs-string">&quot;66f22e1eb5baa344393de75b8133fadd81aa06b9697ef89eb5fcc5d4f1146507&quot;</span>,
  <span class="hljs-string">&quot;blockNumber&quot;</span>: <span class="hljs-number">6351</span>,
  <span class="hljs-string">&quot;transactionHash&quot;</span>: <span class="hljs-string">&quot;ea267d815839a89db017b8c9f83dfa7c15d9b83cff3893c6ca1831e0525dd975&quot;</span>,
  <span class="hljs-string">&quot;transactionIndex&quot;</span>: <span class="hljs-number">1</span>,
  <span class="hljs-string">&quot;from&quot;</span>: <span class="hljs-string">&quot;eb6a149ec16aaaa6e47b6c0048520f7d9563b20a&quot;</span>,
  <span class="hljs-string">&quot;to&quot;</span>: <span class="hljs-string">&quot;d7329343d159af9b628212e4ec6986d54882b3f3&quot;</span>,
  <span class="hljs-string">&quot;cumulativeGasUsed&quot;</span>: <span class="hljs-number">29025</span>,
  <span class="hljs-string">&quot;gasUsed&quot;</span>: <span class="hljs-number">29025</span>,
  <span class="hljs-string">&quot;contractAddress&quot;</span>: <span class="hljs-string">&quot;d7329343d159af9b628212e4ec6986d54882b3f3&quot;</span>,
  <span class="hljs-string">&quot;logs&quot;</span>: [
    {
      <span class="hljs-string">&quot;newEndsAt&quot;</span>: <span class="hljs-string">&quot;5a7c063b&quot;</span>,
      <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;EndsAtChanged&quot;</span>
    }
  ],
  <span class="hljs-string">&quot;rawlogs&quot;</span>: [
    {
      <span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;d7329343d159af9b628212e4ec6986d54882b3f3&quot;</span>,
      <span class="hljs-string">&quot;topics&quot;</span>: [
        <span class="hljs-string">&quot;d34bb772c4ae9baa99db852f622773b31c7827e8ee818449fef20d30980bd310&quot;</span>
      ],
      <span class="hljs-string">&quot;data&quot;</span>: <span class="hljs-string">&quot;000000000000000000000000000000000000000000000000000000005a7c063b&quot;</span>
    }
  ]
}</code></pre>
<h2 id="success-finalize-the-crowdsale"><a name="success-finalize-the-crowdsale" class="plugin-anchor" href="#success-finalize-the-crowdsale"><i class="fa fa-link" aria-hidden="true"></i></a>Success: Finalize The Crowdsale</h2><p>Suppose the funding goal was reached, invoking <a href="https://github.com/TokenMarketNet/ico/blob/2835f331fd9a9356131dfcf0ddd2cee471b9e32f/contracts/CrowdsaleBase.sol#L226" target="_blank">finalize</a> will release the token for transferring.</p><pre><code class="lang-js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">finalize</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> finalized = <span class="hljs-keyword">await</span> crowdsale.return(<span class="hljs-string">&quot;finalized&quot;</span>)

  <span class="hljs-keyword">if</span> (finalized) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&quot;crowdsale is already finalized&quot;</span>)
  }

  <span class="hljs-keyword">const</span> tx = <span class="hljs-keyword">await</span> crowdsale.send(<span class="hljs-string">&quot;finalize&quot;</span>)
  <span class="hljs-keyword">const</span> receipt = <span class="hljs-keyword">await</span> tx.confirm(<span class="hljs-number">1</span>)
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;finalize receipt:&quot;</span>, receipt)
}</code></pre>
<p>Run the CLI script:</p><pre><code>node index.js finalize</code></pre>
<p>The output:</p><pre><code>finalize receipt:

{ blockHash: &apos;1bb4bce0b258eb5cb7fa99cc59d1c3e8eca7fabdba98bf1ddcf329ba35943f00&apos;,
  blockNumber: 6468,
  transactionHash: &apos;460942ae789a0c86674663fe9740bfbe5db843efec64a8074d35bcba31eb7d7c&apos;,
  transactionIndex: 1,
  from: &apos;eb6a149ec16aaaa6e47b6c0048520f7d9563b20a&apos;,
  to: &apos;004fece7860cfa26a5be3009020430440e4784a4&apos;,
  cumulativeGasUsed: 83254,
  gasUsed: 83254,
  contractAddress: &apos;004fece7860cfa26a5be3009020430440e4784a4&apos;,
  logs: [],
  rawlogs: [] }</code></pre>
<h3 id="testing-token-transfer"><a name="testing-token-transfer" class="plugin-anchor" href="#testing-token-transfer"><i class="fa fa-link" aria-hidden="true"></i></a>Testing Token Transfer</h3><p>After finalizing, the tokens should become transferrable. Let&apos;s generate a new address and try to send it some tokens:</p><pre><code>qcli getnewaddress
qdobbjdAGJmi4Syu7EjDN7XcdE8nFpbgCm

qcli gethexaddress qdobbjdAGJmi4Syu7EjDN7XcdE8nFpbgCm
de12b9e72a21394a405ce1830e223beaf2dc1a40</code></pre>
<p>One of the investor should have 7000000 tokens from the ICO:</p><pre><code>node index.js balanceOf 6607919dd81d8e958b31e2ef089139505faada4d

balance: 7000000</code></pre>
<p>We need to prefund the sender address with UTXOs to pay for transactions:</p><pre><code>$ qcli fromhexaddress 6607919dd81d8e958b31e2ef089139505faada4d
qSrs9VHVveZpiYojiaZc8VAz8JJFDu9y7o

$ solar prefund qSrs9VHVveZpiYojiaZc8VAz8JJFDu9y7o 0.1 100</code></pre>
<p>Now, transfer 1000 tokens to the address <code>de12b9e72a21394a405ce1830e223beaf2dc1a40</code>:</p><pre><code>node index.js transfer \
  qSrs9VHVveZpiYojiaZc8VAz8JJFDu9y7o \
  de12b9e72a21394a405ce1830e223beaf2dc1a40 \
  1000</code></pre>
<p>After confirmation, the balance of the receiving address should be 1000:</p><pre><code>node index.js balanceOf \
  de12b9e72a21394a405ce1830e223beaf2dc1a40</code></pre>
<p>And the balance of the original sender should have decremented by 1000:</p><pre><code>node index.js balanceOf \
  6607919dd81d8e958b31e2ef089139505faada4d
balance: 6999000</code></pre>
<p>Congrats, you have completed a successful crowdsale!</p><h2 id="failure-refund-the-crowdsale"><a name="failure-refund-the-crowdsale" class="plugin-anchor" href="#failure-refund-the-crowdsale"><i class="fa fa-link" aria-hidden="true"></i></a>Failure: Refund The Crowdsale</h2><p>Suppose the crowdsale ended but the minimum funding goal was not reached:</p><pre><code>node index.js info
token supply: 37000000
crowdsale state: PreFunding
crowdsale start date: 2018-01-15T00:00:00.000Z
crowdsale end date: 2018-02-08T09:43:00.000Z
investor count: 1
qtum raised: 7000
tokens sold: 7000000
minimum funding goal: 12000
minimum funding goal reached: false</code></pre>
<p>We could extend the end date to give investors more time. But in this demostration we&apos;ll just refund everyone.</p><p>To initiate the refund process:</p><ol><li>The crowdsale owner invokes <a href="https://github.com/TokenMarketNet/ico/blob/2835f331fd9a9356131dfcf0ddd2cee471b9e32f/contracts/CrowdsaleBase.sol#L315" target="_blank">loadRefund</a> to fund the contract with the total amount raised so far.
</li>
<li>Individual investor invoke <a href="https://github.com/TokenMarketNet/ico/blob/2835f331fd9a9356131dfcf0ddd2cee471b9e32f/contracts/CrowdsaleBase.sol#L326" target="_blank">refund</a> to claim the fund.
</li></ol>
<h3 id="owner-loading-refund"><a name="owner-loading-refund" class="plugin-anchor" href="#owner-loading-refund"><i class="fa fa-link" aria-hidden="true"></i></a>Owner Loading Refund</h3><pre><code class="lang-js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadRefund</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> amountRaised = <span class="hljs-keyword">await</span> crowdsale.returnCurrency(<span class="hljs-string">&quot;qtum&quot;</span>, <span class="hljs-string">&quot;weiRaised&quot;</span>)

  <span class="hljs-keyword">const</span> loadedRefund = <span class="hljs-keyword">await</span> crowdsale.returnCurrency(<span class="hljs-string">&quot;qtum&quot;</span>, <span class="hljs-string">&quot;loadedRefund&quot;</span>)

  <span class="hljs-keyword">const</span> amountToLoad = amountRaised - loadedRefund

  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;amount to load as refund&quot;</span>, amountToLoad)

  <span class="hljs-keyword">if</span> (amountToLoad &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">const</span> tx = <span class="hljs-keyword">await</span> crowdsale.send(<span class="hljs-string">&quot;loadRefund&quot;</span>, [], {
      amount: amountToLoad,
    })
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;tx:&quot;</span>, tx)
    <span class="hljs-keyword">const</span> receipt = <span class="hljs-keyword">await</span> tx.confirm(<span class="hljs-number">1</span>)
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;receipt&quot;</span>, receipt)
  }
}</code></pre>
<pre><code>node index.js loadRefund</code></pre>
<h3 id="investor-claiming-fund"><a name="investor-claiming-fund" class="plugin-anchor" href="#investor-claiming-fund"><i class="fa fa-link" aria-hidden="true"></i></a>Investor Claiming Fund</h3><p>The amount invested by <code>6607919dd81d8e958b31e2ef089139505faada4d</code> should be 7000 qtum:</p><pre><code>node index.js investedBy \
 6607919dd81d8e958b31e2ef089139505faada4d

invested by: 6607919dd81d8e958b31e2ef089139505faada4d
amount (qtum): 7000
token balance: 7000000</code></pre>
<p>The investory can invoke <a href="https://github.com/TokenMarketNet/ico/blob/2835f331fd9a9356131dfcf0ddd2cee471b9e32f/contracts/CrowdsaleBase.sol#L326" target="_blank">refund</a> like this:</p><pre><code class="lang-js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">refund</span>(<span class="hljs-params">addr</span>) </span>{
  <span class="hljs-keyword">const</span> tx = <span class="hljs-keyword">await</span> crowdsale.send(<span class="hljs-string">&quot;refund&quot;</span>, [], {
    senderAddress: addr,
  })
  <span class="hljs-keyword">const</span> receipt = <span class="hljs-keyword">await</span> tx.confirm(<span class="hljs-number">1</span>)
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;receipt&quot;</span>, receipt)
}</code></pre>
<p>Running the CLI:</p><pre><code>node index.js refund \
  qSrs9VHVveZpiYojiaZc8VAz8JJFDu9y7o

{ blockHash: &apos;09ea6c4cdf9e0007d21d43f9a3f6fe9fd124621118d8384bb9c6575a04320faa&apos;,
  blockNumber: 6641,
  transactionHash: &apos;11290f6e8809a94273d12fe202c5f2898e14be3f51edf81c43b73bf4259c412d&apos;,
  transactionIndex: 1,
  from: &apos;6607919dd81d8e958b31e2ef089139505faada4d&apos;,
  to: &apos;8a4e597e966b9c8886c006ce84168b9fc6734c22&apos;,
  cumulativeGasUsed: 53815,
  gasUsed: 53815,
  contractAddress: &apos;8a4e597e966b9c8886c006ce84168b9fc6734c22&apos;,
  logs:
   [ Result {
       investor: &apos;6607919dd81d8e958b31e2ef089139505faada4d&apos;,
       weiAmount: &lt;BN: a2fb405800&gt;,
       type: &apos;Refund&apos; } ],
  rawlogs:
   [ { address: &apos;8a4e597e966b9c8886c006ce84168b9fc6734c22&apos;,
       topics: [Array],
       data: &apos;0000000000000000000000006607919dd81d8e958b31e2ef089139505faada4d000000000000000000000000000000000000000000000000000000a2fb405800&apos; } ] }</code></pre>
<p>Use the <code>listunspent</code> command to check if the fund had indeed been returned:</p><pre><code>qcli listunspent 0 999990 \
  &apos;[&quot;qSrs9VHVveZpiYojiaZc8VAz8JJFDu9y7o&quot;]&apos;</code></pre>
<p>There should be an UTXO created for this address with 7000 qtum:</p><pre><code>[
  // other UTXOs ...

  {
    &quot;txid&quot;: &quot;e0afc2742ffa636c6ff788fbb808f5b34276206d713bb25874cb0e48a0070974&quot;,
    &quot;vout&quot;: 0,
    &quot;address&quot;: &quot;qSrs9VHVveZpiYojiaZc8VAz8JJFDu9y7o&quot;,
    &quot;account&quot;: &quot;&quot;,
    &quot;scriptPubKey&quot;: &quot;76a9146607919dd81d8e958b31e2ef089139505faada4d88ac&quot;,
    &quot;amount&quot;: 7000.00000000,
    &quot;confirmations&quot;: 5,
    &quot;spendable&quot;: true,
    &quot;solvable&quot;: true
  }
]</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="vevue-ico/" class="navigation navigation-prev " aria-label="Previous page: Simple Crowdsale">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../part4/inspect-raw-tx.html" class="navigation navigation-next " aria-label="Next page: Inspect Raw TX">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Complex Crowdsale","level":"4.2","depth":1,"next":{"title":"Inspect Raw TX","level":"5.1","depth":1,"path":"part4/inspect-raw-tx.md","ref":"part4/inspect-raw-tx.md","articles":[]},"previous":{"title":"Simple Crowdsale","level":"4.1","depth":1,"path":"part3/vevue-ico/README.md","ref":"part3/vevue-ico/README.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["anchors"],"pluginsConfig":{"anchors":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"part3/ico.md","mtime":"2018-02-08T11:19:53.000Z","type":"markdown"},"gitbook":{"version":"3.2.0","time":"2018-04-22T03:20:43.934Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

